{% extends 'base.html' %}


{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static',filename='css/custom.css') }}">
<link rel="stylesheet" href="{{ url_for('static',filename='css/my_select.css') }}">
<style>
    #work-content-title {
        padding-top: 5px;
        padding-bottom: 5px;
    }

    .list-group-item {
        padding-top: 0;
        padding-bottom: 0;
        border: none;
    }

    .alert {
        position: fixed;
        top: 56px;
    }

    .table-striped>tbody>tr:nth-child(2n+1)>td,
    .table-striped>tbody>tr:nth-child(2n+1)>th {
        background-color: #F6F8FA
    }

    .thead {
        font-size: 13px;
    }

    .thead-sm {
        font-size: 10px;
    }

    .dropdown-menu {
        max-height: 300px;
    }

    .card {
        background: white;
        box-shadow: 0px 0px 0px grey;
        transition: box-shadow .2s ease-out;
        box-shadow: .8px .9px 3px grey;
    }

    .card:hover {
        box-shadow: 1px 8px 20px grey;
        transition: box-shadow .2s ease-in;
    }

    .tuning-type .dropdown-toggle {
        width: 120px!important;
    }

    .tuning-type .dropdown-menu {
        min-width: 120px!important;
    }
    

    /* svg path,svg rect{fill: #FF6700;} */
</style>
{% endblock styles %}
{% block content %}
<div class="container fixed-top col-sm-2">
    <div class="alert mx-auto alert-dismissible fade" id="alert" role="alert" style="width: 240px;">
        <strong id="alert-text"></strong>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
</div>

<header class="navbar navbar-expand-lg navbar-dark bd-navbar navbar-static-top">
    <div class="container-fluid" id="top-navbar">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">
            <span><img src="{{ url_for('static', filename='img/title-logo.png') }}" alt="" height="35px">
                <label style="color: white; font-weight: bold; font-size: 18px;"> 定制化控制业务工作台（暂定）</label>
            </span>
        </a>
        <button class="navbar-toggler btn-sm" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
            style="height: 35px;">
            <span class="fas fa-bars"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link active" id="nav-xml"
                        href="{{ url_for('task.work', taskname=task.name) }}">Symbols</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="blank" onclick="campbellTrigger()">Campbell</a>
                </li>
                <li class="nav-item" style="border-color: #ffe484;padding: 0px 16px;">
                    <span class="algolia-autocomplete algolia-autocomplete-left"
                        style="position: relative; display: inline-block; direction: ltr;"><input type="search"
                            class="form-control ds-input" id="symbol-search-input" placeholder="Search..."
                            aria-label="Search for..." autocomplete="off" data-docs-version="4.3" spellcheck="false"
                            role="combobox" aria-autocomplete="list" aria-expanded="false"
                            aria-owns="algolia-autocomplete-listbox-0" dir="auto"
                            style="position: relative; vertical-align: top; width: 400px;"
                            oninput="searchInpuChanged()">
                        <span class="dropdown-menu dropdown-menu-left" role="listbox"
                            id="algolia-autocomplete-listbox-0" style="min-width: 100%;">
                            <div class="list-group list-group-flush" id="name-list"></div>
                        </span>
                    </span>
                </li>
            </ul>
            <form class="form-inline my-3 my-lg-0">
                <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle btn-bd-download" type="button" id="dropdownMenu2"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                        style="width: 130px; height: 35px;">
                        <i class="fas fa-user-cog"></i> {{ user.realname }}
                    </button>
                    <div class="dropdown-menu  dropdown-menu-left" aria-labelledby="dropdownMenu2"
                        style="min-width: 100%">
                        <button class="dropdown-item" type="button" data-toggle="modal" data-target="#ProfileModal">
                            <span><i class="fas fa-user" style="color: gray"></i> 个人信息</span>
                        </button>
                        <a class="dropdown-item" href="{{ url_for('auth.reset') }}">
                            <span><i class="fas fa-lock" style="color: gray"></i> 修改密码</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                            <span><i class="fas fa-sign-out-alt" style="color: gray"></i> 注销</span>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</header>

<!-- unsave tips modal -->
<div class="modal fade" id="unsave-modal" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color:#7952b3;">
                    <i class='far fa-question-circle'></i> 提示
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <label for="">
                    当前页面尚未保存，是否继续？
                </label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal"
                    onclick="showSearchResult('unsave')">忽略并继续</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal"
                    onclick="showSearchResult('save')">保存并继续</button>
            </div>
        </div>
    </div>
</div>

<!-- tip Modal -->
<div class="modal fade" id="campbell-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color:#7952b3;">Campbell</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <select class="selectpicker col-7" id="modes-selectpicker" data-style="btn-outline-0"
                        style="padding-right: 0px;">
                    </select>
                    <div class="col-4" style="padding: 0px 0px;">
                        <div class="input-group" style="width: 150px;">
                            <input type="text" class="form-control" id="mode_freq">
                            <div class="input-group-append">
                                <span class="input-group-text" id="unit">rad/s</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-1"
                        style="padding-left: 0px; text-decoration:underline; font-size: 13px; align-self: center;">
                        <a data-toggle="collapse" href="#collapseTable" id="more-modes">更多</a>
                    </div>
                </div>
                <div class="collapse" id="collapseTable">
                    <div class="table-responsive">
                        <table id="modes-table" data-resizable="true"
                            class="table table-striped table-sm table-bordered table-hover">
                        </table>
                    </div>
                </div>

                <label id="noCalcLabel">

                </label>
                <div class="form-check" id="reCampbellForm" style="display: none;">
                    <input class="form-check-input" type="checkbox" value="" id="reCampbell"
                        onchange="reCampbellConfirm()">
                    <label class="form-check-label text-info" for="reCampbell">
                        该项目已有历史计算，重新计算请勾选此项。
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="campbell()"
                    id="campbellCalcBtn" data-toggle="modal" data-target="#SavingModal">开始计算</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Save Modal -->
<div class="modal fade" id="ConfirmSaveModal" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 style="font-weight: bold; color: #7952b3;">
                    <i class="fas fa-save"></i> 保存
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-row">
                        <div class="form-group col-10">
                            <label for="rename">文件名：</label>
                            <input type="text" class="form-control" id="rename" autocomplete="off"
                                placeholder="{{ task.xml_filename }}">
                        </div>

                        <div class="form-group col-2 tuning-type">
                            <label for="uning-type-selectpicker">调参类型：</label>
                            <select class="selectpicker" id="tuning-type-selectpicker" data-style="btn-outline-0">
                                <option value="1">初版整定</option>
                                <option value="2">降载迭代</option>
                                <option value="3">特殊需求</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">备注：</label>
                        <textarea class="form-control" id="description" rows="10"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">放弃</button>
                <button type="button" class="btn btn-info symbol-save-btn" data-dismiss="modal" id="save-btn"
                    onclick="savePage(false)">保存至工作区</button>
                {% if task.isgitted %}
                <button type="button" class="btn btn-primary symbol-save-btn" data-dismiss="modal" data-toggle="modal"
                    id="save-git-btn" data-target="#SavingModal" onclick="savePage(true)">保存并提交至Git</button>
                {% else %}
                <button type="button" class="btn btn-primary symbol-save-btn" data-dismiss="modal" data-toggle="modal"
                    data-target="#SavingModal" disabled">保存并提交至Git</button>
                {% endif %}
            </div>

        </div>
    </div>
</div>
<!-- Saving Modal -->
<div class="modal fade" id="SavingModal" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-body text-center">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="48px" height="60px"
                viewBox="0 0 24 30" style="enable-background:new 0 0 50 50;" xml:space="preserve">
                <rect x="0" y="0" width="4" height="10" fill="#FF6700" transform="translate(0 15.1665)">
                    <animateTransform attributeType="xml" attributeName="transform" type="translate"
                        values="0 0; 0 20; 0 0" begin="0" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </rect>
                <rect x="10" y="0" width="4" height="10" fill="#FF6700" transform="translate(0 11.5002)">
                    <animateTransform attributeType="xml" attributeName="transform" type="translate"
                        values="0 0; 0 20; 0 0" begin="0.2s" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </rect>
                <rect x="20" y="0" width="4" height="10" fill="#FF6700" transform="translate(0 1.83315)">
                    <animateTransform attributeType="xml" attributeName="transform" type="translate"
                        values="0 0; 0 20; 0 0" begin="0.4s" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </rect>
            </svg>
            <p id="modal-status" style="color: white;" Bold>正在保存......</p>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="ProfileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">个人信息 - {{ user.realname }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">总任务数:</label>
                        <input type="text" class="form-control" value="{{ tasks_amount }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">用户名：</label>
                        <input type="text" class="form-control" value="{{ user.username }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">职位：</label>
                        <input type="text" class="form-control" value="{{ user.role }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">电子邮箱：</label>
                        <input type="text" class="form-control" value="{{ user.email }}" disabled>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
            </div>
        </div>
    </div>
</div>

<div class="container-fluid" onscroll="scroll()">
    <div id="work-content-title">
        <div class="d-md-flex justify-content-between">
            <div class="p-2 align-self-center">
                <div>
                    <label style="font-size: 18px; font-weight: bold;">{{ task.name }}</label>
                </div>
            </div>
            <div class="p-2 flex-grow-1"></div>
            <div class="p-2 align-self-center">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="edit-switch" onchange="editModeSwitch()">
                    <label class="custom-control-label" for="edit-switch" id="edit-switch-label">只读</label>
                </div>
            </div>

            <div class="p-2 align-self-center">
                <button type="submit" class="btn btn-bd-primary" id="save-submit" onclick="savePageTrigger()">
                    <i class="fas fa-cloud-upload-alt"></i> 保存
                </button>
            </div>
            <div class="p-2 align-self-center">
                <a class="btn btn-bd-primary" href="{{ url_for('task.download', taskname=task.name) }}">
                    <i class="fas fa-cloud-download-alt"></i> 下载
                </a>
                <!-- <button type="submit" class="btn btn-bd-primary" id="download" onclick="download()">
                    <i class="fas fa-cloud-download-alt"></i> 下载
                </button> -->
            </div>
            <div class="p-2 align-self-center">
                <a class="btn btn-bd-primary" href="{{ url_for('task.watch', taskname=task.name) }}" target="blank">
                    <i class="fas fa-eye"></i> 查看
                </a>
            </div>
        </div>

        <nav id="tabs-nav" style="display: block;">
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" id="nav-params-tab" data-toggle="tab" href="#nav-params" role="tab"
                    aria-controls="nav-home" aria-selected="true">Params</a>
                <a class="nav-item nav-link" id="nav-schedules-tab" data-toggle="tab" href="#nav-schedules" role="tab"
                    aria-controls="nav-profile" aria-selected="false">Schedules</a>
                <a class="nav-item nav-link" id="nav-filters-tab" data-toggle="tab" href="#nav-filters" role="tab"
                    aria-controls="nav-contact" aria-selected="false">Filters</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-params" role="tabpanel" aria-labelledby="nav-params-tab">
                <div class="d-lg-flex">
                    <div class="p-4 table-responsive">
                        <table id="params-table" data-resizable="true"
                            class="table table-striped table-sm table-bordered table-hover">
                        </table>
                    </div>
                    <div class="p-4" style="padding-top: 24px; position: relative;" id="tool-block">
                        <div class="card">
                            <div class="card-header">
                                参数变动
                            </div>
                            <div class="card-body" id="changedShowArea">
                                
                            </div>
                        </div>
                        <div style="padding-top: 24px;" id="unit-block">
                            <div class="card">
                                <div class="card-header">
                                    单位换算
                                </div>
                                <div class="card-body">
                                    <form>
                                        <div class="d-flex">
                                            <div class="p-2 align-self-center flex-grow-1">
                                                <div class="form-label-group" style="margin-bottom: 0px;">
                                                    <input type="text" id="deg" class="form-control" placeholder="Deg">
                                                    <label style="color: #7952b3;">Deg</label>
                                                </div>
                                            </div>
                                            <div class="p-1 align-self-center arrow" id="rad-to-deg"
                                                style="cursor: pointer;">
                                                <i class="fas fa-arrow-alt-circle-left"></i>
                                            </div>
                                            <div class="p-1 align-self-center arrow" id="deg-to-rad"
                                                style="cursor: pointer;">
                                                <i class="fas fa-arrow-alt-circle-right"></i>
                                            </div>
                                            <div class="p-2 align-self-center flex-grow-1">
                                                <div class="form-label-group" style="margin-bottom: 0px;">
                                                    <input type="text" id="rad" class="form-control" placeholder="Rad">
                                                    <label style="color: #7952b3;">Rad</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex">
                                            <div class="p-2 align-self-center flex-grow-1">
                                                <div class="form-label-group" style="margin-bottom: 0px;">
                                                    <input type="text" id="rpm" class="form-control" placeholder="rpm">
                                                    <label style="color: #7952b3;">rpm</label>
                                                </div>
                                            </div>
                                            <div class="p-1 align-self-center arrow" id="radpsto-rpm"
                                                style="cursor: pointer;">
                                                <i class="fas fa-arrow-alt-circle-left"></i>
                                            </div>
                                            <div class=" p-1 align-self-center arrow" id="rpm-toradps"
                                                style="cursor: pointer;">
                                                <i class="fas fa-arrow-alt-circle-right"></i>
                                            </div>
                                            <div class="p-2 align-self-center flex-grow-1">
                                                <div class="form-label-group" style="margin-bottom: 0px;">
                                                    <input type="text" id="radpsrpm" class="form-control"
                                                        placeholder="rad/s">
                                                    <label style="color: #7952b3;">rad/s</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex">
                                            <div class="p-2 align-self-center flex-grow-1">
                                                <div class="form-label-group" style="margin-bottom: 0px;">
                                                    <input type="text" id="Hz" class="form-control" placeholder="Hz">
                                                    <label style="color: #7952b3;">Hz</label>
                                                </div>
                                            </div>
                                            <div class="p-1 align-self-center arrow" id="radpsto-Hz"
                                                style="cursor: pointer;">
                                                <i class="fas fa-arrow-alt-circle-left"></i>
                                            </div>
                                            <div class="p-1 align-self-center arrow" id="Hz-toradps"
                                                style="cursor: pointer;">
                                                <i class="fas fa-arrow-alt-circle-right"></i>
                                            </div>
                                            <div class="p-2 align-self-center flex-grow-1">
                                                <div class="form-label-group" style="margin-bottom: 0px;">
                                                    <input type="text" id="radpshz" class="form-control"
                                                        placeholder="rad/s">
                                                    <label style="color: #7952b3;">rad/s</label>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div style="padding-top: 24px;" id="towerExc-block">
                            <div class="card">
                                <div class="card-header">
                                    <span>
                                        跳转速设置
                                        <i class="fas fa-info-circle tips" data-toggle="tooltip"
                                            title="Kopt使用Bladed模型里的值"></i>
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between" style="padding-bottom: 16px;">
                                        <div class="p-2 align-self-center" style="padding: 0px 0px!important">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="towerExc-switch"
                                                    onchange="towerExcSwitch()">
                                                <label class="custom-control-label" for="towerExc-switch"
                                                    id="towerExcSwitch-label">开关</label>
                                            </div>
                                        </div>
                                        <div class="p-2 align-self-center" style="padding: 0px 0px!important;" fade>
                                            <span class="badge badge-success" id="result-badge"
                                                style="display: none;">通过</span>
                                        </div>
                                        <div class="p-2 align-self-center" style="padding: 0px 0px!important">
                                            <button class="btn btn-sm btn-info" id="reset" data-toggle="tooltip"
                                                title="恢复默认" onclick="reset()"><i class="fas fa-redo"></i></button>
                                            <button class="btn btn-sm btn-primary" id="apply"
                                                onclick="setTowerExc()">应用</button>
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                        <div class="form-label-group">
                                            <input type="text" style="color: green;" class="form-control"
                                                id="tower1st-radps">
                                            <label style="color: #7952b3;font-size:5px;">塔架一阶(rad/s)</label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: green;" class="form-control"
                                                id="tower1st-hz">
                                            <label style="color: #7952b3;">塔架一阶(Hz)</label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: green;" class="form-control"
                                                id="tower1st-rpm">
                                            <label style="color: #7952b3;">塔架一阶(rpm)</label>
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                        <div class="form-label-group">
                                            <input type="text" style="color: #FF6600" class="form-control" value="0.05"
                                                id="SpeedFactor">
                                            <label style="color: #7952b3;">转速系数</label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: #FF6600" class="form-control" value="0.5"
                                                id="SpeedOffset">
                                            <label style="color: #7952b3;">转速偏移(rpm)</label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: #FF6600" class="form-control" value="1.05"
                                                id="LowTorqueFactor">
                                            <label style="color: #7952b3;">扭矩系数low</label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: #FF6600" class="form-control" value="0.09"
                                                id="HighTorqueFactor">
                                            <label style="color: #7952b3;">扭矩系数high</label>
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                        <div class="form-label-group">
                                            <input type="text" style="color: blue;" class="form-control" id="LowSpeed"
                                                disabled>
                                            <label style="color: #7952b3;">低转速<label id="LowSpeed-rpm"
                                                    style="color: green;"></label></label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: blue;" class="form-control" id="HighSpeed"
                                                disabled>
                                            <label style="color: #7952b3;">高转速<label id="HighSpeed-rpm"
                                                    style="color: green;"></label></label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: blue;" class="form-control"
                                                id="LowSpeedMaxTorque" disabled>
                                            <label style="color: #7952b3;">低转速扭矩</label>
                                        </div>
                                        <div class="p-2" style="padding: 3px!important;"></div>
                                        <div class="form-label-group">
                                            <input type="text" style="color: blue;" class="form-control"
                                                id="HighSpeedMaxTorque" disabled>
                                            <label style="color: #7952b3;">高转速扭矩</label>
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-schedules" role="tabpanel" aria-labelledby="nav-schedules-tab">
                <div class="table-responsive">
                    <table id="schedules-table" data-resizable="true"
                        class="table table-striped table-sm table-bordered table-hover">
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-filters" role="tabpanel" aria-labelledby="nav-filters-tab">
                <div class="table-responsive">
                    <table id="filters-table" data-resizable="true"
                        class="table table-striped table-sm table-bordered table-hover table-header-rotated">
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // 避免select第一次点击无效 
    $('select').selectpicker();

    window.onscroll = function () {
        if (document.documentElement.scrollTop > 5) {
            $(".navbar")[0].style.boxShadow = "0px 6px 5px rgba(121,82,179,.25)";
        } else {
            $(".navbar")[0].style.boxShadow = "";
        }
    }
    $(function () {
        $('#deg').keyup(function () {
            var src = $(this).val();
            if (isNaN(src) || src == "") {
                $('#rad').val("");
            } else {
                $('#rad').val(src * Math.PI / 180);
            }
        })
    })
    $(function () {
        $('#rad').keyup(function () {
            var src = $(this).val();
            if (isNaN(src) || src == "") {
                $('#deg').val("");
            } else {
                $('#deg').val(src * 180 / Math.PI);
            }
        })
    })
    $(function () {
        $('#rpm').keyup(function () {
            var src = $(this).val();
            if (isNaN(src) || src == "") {
                $('#radpsrpm').val("");
            } else {
                $('#radpsrpm').val(src * Math.PI / 30);
            }
        })
    })
    $(function () {
        $('#radpsrpm').keyup(function () {
            var src = $(this).val();
            if (isNaN(src) || src == "") {
                $('#rpm').val("");
            } else {
                $('#rpm').val(src * 30 / Math.PI);
            }
        })
    })
    $(function () {
        $('#Hz').keyup(function () {
            var src = $(this).val();
            if (isNaN(src) || src == "") {
                $('#radpshz').val("");
            } else {
                $('#radpshz').val(src * 2 * Math.PI);
            }
        })
    })
    $(function () {
        $('#radpshz').keyup(function () {
            var src = $(this).val();
            if (isNaN(src) || src == "") {
                $('#Hz').val("");
            } else {
                $('#Hz').val(src / 2 / Math.PI);
            }
        })
    })

    $(function () {
        $('#tower1st-radps').keyup(function () {
            var src = $(this).val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-hz').val("");
                $('#tower1st-rpm').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
            } else {
                $('#tower1st-hz').val((src / 2 / Math.PI).toFixed(5));
                $('#tower1st-rpm').val((src * 30 / Math.PI).toFixed(5));
                // enableApplyBtn();
            }
            towerExcCalc(kopt, src);
        })
    })

    $(function () {
        $('#tower1st-hz').keyup(function () {
            var src = $(this).val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-radps').val("");
                $('#tower1st-rpm').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
                $("#result-badge")[0].style.display = "none";
            } else {
                $('#tower1st-radps').val((src * 2 * Math.PI));
                $('#tower1st-rpm').val(src * 60);
                // enableApplyBtn();
            }
            towerExcCalc(kopt, $('#tower1st-radps').val());
        })
    })

    $(function () {
        $('#tower1st-rpm').keyup(function () {
            var src = $(this).val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-radps').val("");
                $('#tower1st-hz').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
                $("#result-badge")[0].style.display = "none";
            } else {
                $('#tower1st-radps').val((src * Math.PI / 30));
                $('#tower1st-hz').val((src / 60));
                // enableApplyBtn();
            }
            towerExcCalc(kopt, $('#tower1st-radps').val());
        })
    })

    $(function () {
        $('#SpeedFactor').keyup(function () {
            var src = $('#tower1st-radps').val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-radps').val("");
                $('#tower1st-hz').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
                $("#result-badge")[0].style.display = "none";
            } else {
                // enableApplyBtn();
            }
            towerExcCalc(kopt, src);
        })
    })

    $(function () {
        $('#SpeedOffset').keyup(function () {
            var src = $('#tower1st-radps').val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-radps').val("");
                $('#tower1st-hz').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
                $("#result-badge")[0].style.display = "none";
            } else {
                // enableApplyBtn();
            }
            towerExcCalc(kopt, src);
        })
    })

    $(function () {
        $('#LowTorqueFactor').keyup(function () {
            var src = $('#tower1st-radps').val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-radps').val("");
                $('#tower1st-hz').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
                $("#result-badge")[0].style.display = "none";
            } else {
                // enableApplyBtn();
            }
            towerExcCalc(kopt, src);
        })
    })

    $(function () {
        $('#HighTorqueFactor').keyup(function () {
            var src = $('#tower1st-radps').val();
            var kopt = Number($("#P_OptimalModeGain-bladed").val());
            if (isNaN(src) || src == "") {
                $('#tower1st-radps').val("");
                $('#tower1st-hz').val("");
                $("#LowSpeed").val("");
                $("#HighSpeed").val("");
                enableApplyBtn();
                $("#result-badge")[0].style.display = "none";
            } else {
                // enableApplyBtn();
            }
            towerExcCalc(kopt, src);
        })
    })

    function enableApplyBtn() {
        $("#apply")[0].classList.remove("btn-secondary");
        $("#apply")[0].classList.add("btn-primary");
        $("#apply")[0].disabled = false;
    }

    function disableApplyBtn() {
        $("#apply")[0].classList.remove("btn-primary");
        $("#apply")[0].classList.add("btn-secondary");
        $("#apply")[0].disabled = true;
    }

    function reset() {
        $("#SpeedFactor").val(0.05);
        $("#SpeedOffset").val(0.5);
        $("#LowTorqueFactor").val(1.05);
        $("#HighTorqueFactor").val(0.09);
        var kopt = Number($("#P_OptimalModeGain-bladed").val());
        towerExcCalc(kopt, $('#tower1st-radps').val());
    }

    function towerExcCalc(Kopt, tower1st_) {
        var tower1st = Number(tower1st_);
        if (isNaN(tower1st) || tower1st == "") {
            $("#LowSpeed").val("");
            $("#HighSpeed").val("");
            $("#LowSpeedMaxTorque").val("");
            $("#HighSpeedMaxTorque").val("");
            $("#LowSpeed-rpm").text("");
            $("#HighSpeed-rpm").text("");
            $("#result-badge")[0].style.display = "none";
        } else {
            var speedFactor = Number($("#SpeedFactor").val()),
                speedOffset = Number($("#SpeedOffset").val()),
                lowTorqueFactor = Number($("#LowTorqueFactor").val()),
                highTorqueFactor = Number($("#HighTorqueFactor").val()),
                lowSpeed = Math.min(tower1st * (1 - speedFactor), tower1st - speedOffset * Math.PI / 30),
                highSpeed = Math.max(tower1st * (1 + speedFactor), tower1st + speedOffset * Math.PI / 30),
                lowTorque = lowTorqueFactor * Kopt * lowSpeed * lowSpeed,
                highTorque = highTorqueFactor * Kopt * Math.pow(lowSpeed, 3) / highSpeed;
            $("#LowSpeed").val(lowSpeed.toFixed(5));
            $("#HighSpeed").val(highSpeed.toFixed(5));
            $("#LowSpeed-rpm").text((lowSpeed * 30 / Math.PI).toFixed(1) + "rpm");
            $("#HighSpeed-rpm").text((highSpeed * 30 / Math.PI).toFixed(1) + "rpm");
            $("#LowSpeedMaxTorque").val(Math.round(lowTorque));
            $("#HighSpeedMaxTorque").val(Math.round(highTorque));
            var tower1st_radps = $('#tower1st-radps').val();
            if (tower1st_radps.length > 15) {
                $('#tower1st-radps').val(Number(tower1st_radps).toFixed(5));
            }
            var tower1st_hz = $('#tower1st-hz').val();
            if (tower1st_hz.length > 15) {
                $('#tower1st-hz').val(Number(tower1st_hz).toFixed(5));
            }
            var tower1st_rpm = $('#tower1st-rpm').val();
            if (tower1st_rpm.length > 15) {
                $('#tower1st-rpm').val(Number(tower1st_rpm).toFixed(5));
            }

            // 判断是否通过
            var ratedSpeed = Number($("#P_RatedGeneratorSpeed-bladed").val());
            if (highSpeed <= 0.92 * ratedSpeed && highSpeed < ratedSpeed - Math.PI / 30) {
                $("#result-badge").removeClass("badge-danger");
                $("#result-badge").addClass("badge-success");
                $("#result-badge").html("通过");
                $("#result-badge")[0].style.display = "block";
                enableApplyBtn();
            } else {
                disableApplyBtn();
                $("#result-badge").removeClass("badge-success");
                $("#result-badge").addClass("badge-danger");
                $("#result-badge").html("不通过");
                $("#result-badge")[0].style.display = "block";
            }
        }
    }

    function setTowerExc() {
        $("#P_TowerExcEnabled-symbol").val(String($("#towerExc-switch")[0].checked));
        if ("" != $("#LowSpeed").val())
            $("#P_TowerExcLowSpeed-symbol").val($("#LowSpeed").val());
        if ("" != $("#HighSpeed").val())
            $("#P_TowerExcHighSpeed-symbol").val($("#HighSpeed").val());
        if ("" != $("#LowSpeedMaxTorque").val())
            $("#P_TowerExcLowSpeedMaxTorque-symbol").val($("#LowSpeedMaxTorque").val());
        if ("" != $("#HighSpeedMaxTorque").val())
            $("#P_TowerExcHighSpeedMinTorque-symbol").val($("#HighSpeedMaxTorque").val());
    }

    function equals(src, dst) {
        if (src.match(/(\d+)-/)[1] != "0") {
            $("#" + dst).val($("#" + src).val());
        }
    }

    function towerExcSwitch() {
        $("#P_TowerExcEnabled-symbol").val(String($("#towerExc-switch")[0].checked));
    }

    function editModeSwitch() {
        $(function () {
            $('#P_MaximumGeneratorTorque-symbol').val(Math.round($('#P_DMGT-bladed').val() * 1.1));
            $('#P_SteadyShaftPowerLimit-symbol').val(($('#P_RatedGeneratorSpeed-symbol').val() * Number($('#P_DMGT-bladed').val())).toFixed(1));
            $('#P_OptimalModeGain-symbol').val($('#P_OptimalModeGain-bladed').val());
            checkChanged();
        })
        $(function () {
            $('#P_OptimalModeGain-bladed').keyup(function () {
                var src = $(this).val();
                if (isNaN(src) || src == "") {
                    $('#P_OptimalModeGain-symbol').val("");
                } else {
                    $('#P_OptimalModeGain-symbol').val(src);
                }
            })
        })
        $(function () {
            $('#P_DMGT-bladed').keyup(function () {
                var src = $(this).val();
                if (isNaN(src) || src == "") {
                    $('#P_MaximumGeneratorTorque-symbol').val("");
                } else {
                    $('#P_MaximumGeneratorTorque-symbol').val(src * 1.1);
                }
            })
        })
        $(function () {
            $('#P_RatedGeneratorSpeed-symbol').keyup(function () {
                var src = $(this).val();
                if (isNaN(src) || src == "") {
                    $('#P_SteadyShaftPowerLimit-symbol').val("");
                } else {
                    $('#P_SteadyShaftPowerLimit-symbol').val(src * Number($('#P_DMGT-bladed').val()));
                }
            })
        })
        var tableValues = document.getElementsByClassName("table-value");
        if ($("#edit-switch")[0].checked) {
            $("#edit-switch-label").html("编辑");
            $("#edit-switch-label")[0].classList.add('text-primary');
            for (var i = 0; i < tableValues.length; i++) {
                tableValues[i].removeAttribute('style');
                tableValues[i].style.textAlign = "center";
                tableValues[i].disabled = false;
                tableValues[i].classList.add("form-control");
                tableValues[i].classList.add("form-control-sm");
                tableValues[i].style.width = "100px";
                tableValues[i].style.marginLeft = "auto";
                tableValues[i].style.marginRight = "auto";
                if (tableValues[i].classList.contains('enable-col')) {
                    tableValues[i].style.width = "50px";
                    tableValues[i].style.marginLeft = "auto";
                    tableValues[i].style.marginRight = "auto";
                }
                if (tableValues[i].classList.contains('enable-col') ||
                    tableValues[i].classList.contains('num-frequency-col') ||
                    tableValues[i].classList.contains('den-frequency-col')) {
                    tableValues[i].style.backgroundColor = "#ffe484";
                }
            }
        }
        else {
            $("#edit-switch-label").html("只读");
            $("#edit-switch-label")[0].classList.remove('text-primary');
            for (var i = 0; i < tableValues.length; i++) {
                tableValues[i].style.backgroundColor = "transparent";
                tableValues[i].style.textAlign = "center";
                tableValues[i].style.border = 0;
                tableValues[i].style.cursor = "text";
                tableValues[i].disabled = true;
                tableValues[i].classList.remove("form-control");
                tableValues[i].classList.remove("form-control-sm");
                tableValues[i].style.width = "100px";
                tableValues[i].style.marginLeft = "auto";
                tableValues[i].style.marginRight = "auto";
                if (tableValues[i].classList.contains('enable-col')) {
                    tableValues[i].style.width = "50px";
                    tableValues[i].style.marginLeft = "auto";
                    tableValues[i].style.marginRight = "auto";
                }
            }
        }
    }

    $(function () {
        $("#symbol-search-input").keyup(function () {
            var keyWord = $(this).val().toLowerCase();
            $.ajax({
                type: 'POST',
                url: "/task/search/{{ task.name }}",
                dataType: "json",
                contentType: 'application/json; charset=UTF-8',
                data: JSON.stringify(keyWord),
                success: function (data) { //成功的话，得到消息
                    var htmlStr = "";
                    for (var i = 0; i < data.length; i++) {
                        start = data[i].toLowerCase().indexOf(keyWord);
                        end = data[i].toLowerCase().indexOf(keyWord) + keyWord.length;
                        prefix = data[i].slice(0, start);
                        mid = data[i].slice(start, end);
                        postfix = data[i].slice(end);
                        htmlStr += '<a class="list-group-item list-group-item-action" onclick="showSearchResultTrigger(\'' + data[i] + '\')">' +
                            prefix +
                            '<label style="color: #7952b3; font-weight: Bold; cursor: pointer; margin: 2px 0px 3px;">' + mid + '</label>' +
                            postfix + '</a>\n';
                    }
                    var listBox = $("#algolia-autocomplete-listbox-0")[0];
                    if (htmlStr != "") {
                        if (data.length < 15) {
                            listBox.style.overflow = "hidden";
                        } else {
                            listBox.style.overflow = "scroll";
                        }
                        $("#name-list").html(htmlStr);
                        listBox.style.display = "block";
                    } else {
                        listBox.style.display = "none";
                    }
                }
            });
        })
    })

    function searchInpuChanged() {
        var listBox = $("#algolia-autocomplete-listbox-0")[0];
        if ($("#symbol-search-input").val() != "") {
            listBox.style.display = "block";
        } else {
            listBox.style.display = "none";
            getData();
            $("#towerExc-block")[0].style.display = "block";
            $("#tool-block")[0].style.display = "block";
        }
    }

    function showSearchResultTrigger(param) {
        window.searchParam = param;
        var dataChanged = getModifiedTableData();
        if (JSON.stringify(dataChanged) != "{}") {
            $("#unsave-modal").modal('show');
            return;
        }
        showSearchResult('unsave');
    }

    function showSearchResult(flag) {
        var dataChanged = getModifiedTableData();
        if (flag == "save") {
            $.ajax({
                cache: false,
                type: 'POST',
                url: "/task/write/{{ task.name }}",
                dataType: "json",
                contentType: 'application/json; charset=UTF-8',
                data: postData(dataChanged, false),
                success: function (data) {
                    if (JSON.stringify(dataChanged) != "{}") {
                        var list = $(".alert")[0].classList;
                        for (var i = 3; i < list.length; i++) {
                            $('.alert').removeClass(list[i]);
                        }
                        $("#alert-text").html("已保存！");
                        $('.alert').addClass('alert-success').show().delay(2000).fadeOut();
                    }
                    showSearchResult('saved');
                }
            })
            return;
        }
        param = window.searchParam;
        $("#symbol-search-input").val(param);
        var tableData = {};
        $.ajax({
            type: 'POST',
            url: "/task/search/{{ task.name }}/" + param,
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
            }),
            success: function (data) { //成功的话，得到消息
                tableData = data;
            },
            complete: function () {
                initTable(tableData);
                setDisplay(tableData);
                window.pageInitialData = getInitialTableData();
                $("#edit-switch")[0].checked = false;
            }
        });
    }

    function setDisplay(tableData, displayname) {
        $("#algolia-autocomplete-listbox-0")[0].style.display = "none";
        for (var key in tableData) {
            if (String(tableData[key]) != "") {
                $('#nav-tab a[href="#nav-' + key + '"]').tab('show');
                if (key == "filters") {
                    $('#filters-table').bootstrapTable('mergeCells', { index: 0, field: 'Name', colspan: 1, rowspan: tableData['filters'].length });
                }
            }
        }
        $("#towerExc-block")[0].style.display = "none";
        $("#tool-block")[0].style.display = "none";
    }

    function initTable(data) {
        var $paramsTable = $('#params-table');
        $paramsTable.bootstrapTable('destroy').bootstrapTable({
            columns: [
                {
                    title: "参数",
                    field: 'name',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    sortable: true
                },
                {
                    title: "Bladed值",
                    field: 'bladed_value',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                },
                {
                    title: 'Symbol值',
                    field: 'symbol_value',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "说明",
                    field: "description",
                    valign: 'middle',
                    class: "thead-sm"
                }
            ],
            data: data['params']
        });
        $("#towerExc-switch")[0].checked = eval($("#P_TowerExcEnabled-symbol").val());
        var $schedulesTable = $('#schedules-table');
        $schedulesTable.bootstrapTable('destroy').bootstrapTable({
            columns: [
                {
                    title: "参数",
                    field: 'Name',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "20%"
                },
                {
                    title: "Enabled",
                    field: 'Enabled',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "5%"
                },
                {
                    title: "Display Name",
                    field: 'Display_Name',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "0",
                    field: '0',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "1",
                    field: '1',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "2",
                    field: '2',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "3",
                    field: '3',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "4",
                    field: '4',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "5",
                    field: '5',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "6",
                    field: '6',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                {
                    title: "7",
                    field: '7',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    width: "10%"
                },
                // {
                //     title: "8",
                //     field: '8',
                //     align: 'center',
                //     valign: 'middle',
                //     class: "thead",
                //     width: "10%"
                // },
                // {
                //     title: "9",
                //     field: '9',
                //     align: 'center',
                //     valign: 'middle',
                //     class: "thead",
                //     width: "10%"
                // }
            ],
            data: data['schedules']
        });
        if (JSON.stringify(data) != "{}") {
            for (var i = 0; i <= data['schedules'].length; i += 2) {
                $schedulesTable.bootstrapTable('mergeCells', { index: i, field: 'Name', colspan: 1, rowspan: 2 });
                $schedulesTable.bootstrapTable('mergeCells', { index: i, field: 'Enabled', colspan: 1, rowspan: 2 });
            };
        }

        var $filtersTable = $('#filters-table');
        $filtersTable.bootstrapTable('destroy').bootstrapTable({
            columns: [
                {
                    title: "参数",
                    field: 'Name',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Display</br>Name",
                    field: 'Display_Name',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Enabled",
                    field: 'Enabled',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Numerator</br>Type",
                    field: 'Numerator_Type',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Denominator</br>Type",
                    field: 'Denominator_Type',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Numerator</br>TC",
                    field: 'Numerator_TC',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Denominator</br>TC",
                    field: 'Denominator_TC',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Numerator</br>Frequency",
                    field: 'Numerator_Frequency',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Numerator</br>Damping</br>Ratio",
                    field: 'Numerator_Damping_Ratio',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Denominator</br>Frequency",
                    field: 'Denominator_Frequency',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Denominator</br>Damping</br>Ratio",
                    field: 'Denominator_Damping_Ratio',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "W0",
                    field: 'W0',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                },
                {
                    title: "Prewarping</br>Wc",
                    field: 'Prewarping_Wc',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                }
            ],
            data: data['filters']
        });
        if (JSON.stringify(data) != "{}") {
            for (var i = 0, start = 0, delta = 0; i < data['filters'].length; i++) {
                if (i > 0 && $filtersTable.bootstrapTable('getData')[i]['Display_Name'] <= 1) {
                    delta = i - start;
                    $filtersTable.bootstrapTable('mergeCells', { index: start, field: 'Name', colspan: 1, rowspan: delta });
                    start = i;
                }
            }
        }
        $('.name').tooltip('show');
        $('.name').tooltip('hide');
    }
    function getData() {
        var tableData = {};

        $.ajax({
            type: 'POST',
            url: "/task/read/{{ task.name }}",
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
            }),
            success: function (data) { //成功的话，得到消息
                tableData = data;
            },
            complete: function () {
                initTable(tableData);
                window.pageInitialData = getInitialTableData();
                $("#edit-switch")[0].checked = false;
            }
        });
    }
    $(document).ready(function () {
        getData();
        editModeSwitch();
        $(".alert")[0].classList.remove("col-md-4");
        $(".alert").fadeOut();
        $('[data-toggle="tooltip"]').tooltip();
    });

    function getInitialTableData() {
        var tableValues = document.getElementsByClassName("table-value");
        var data = {};
        for (var i = 0; i < tableValues.length; i++) {
            data[tableValues[i].id] = tableValues[i].value;
        }
        return data;
    }

    function checkChanged() {
        var changed = getModifiedTableData();
        var changedArray = [];
        var patt = /(\S+?)\d*-/;
        var changedBadge = '<div class="row">';
        for (property in changed) {
            var m = patt.exec(property);
            if (-1 == changedArray.indexOf(m[1])) {
                changedArray.push(m[1]);
                changedBadge += '<div class="col-auto" style="padding: 5px;">' +
                    '<span class="badge badge-info">' + m[1] + '</span>' +
                    '</div>';
            }
        }
        changedBadge += '</div>';
        $("#changedShowArea").html(changedBadge);
    }

    function getModifiedTableData() {
        var tableValues = document.getElementsByClassName("table-value");
        var data = {};
        for (var i = 0; i < tableValues.length; i++) {
            var id = tableValues[i].id;
            if ($("#" + id).val() != window.pageInitialData[id]) {
                data[id] = { 'new': $("#" + id).val(), 'old': window.pageInitialData[id] };
            }
        }
        return data;
    }

    function savePageTrigger() {        
        var spec = "调参说明：\n\t\n参数变动：\n\t";
        var changed = getModifiedTableData();
        var patt = /(\S+?)(\d*)-(\S+)/;
        for (property in changed){
            var m = patt.exec(property);
            if (0 == property.indexOf('P_')){
                spec += m[1] + ": " + changed[property].old + " -> " + changed[property].new + "\n\t";
            } else{
                spec += (-1 != property.indexOf('Enabled')) ? 
                        m[1] + "[" + m[3] + "]: " + changed[property].old + " -> " + changed[property].new + "\n\t" : 
                        m[1] + "[" + m[2] + "][" + m[3] + "]: " + changed[property].old + " -> " + changed[property].new + "\n\t";
            }
        }
        $("#rename").val("{{ task.xml_filename }}");
        var specShow = ("{}" == JSON.stringify(changed)) ? "" : spec;
        $("#description").text(specShow);
        $("#ConfirmSaveModal").modal();
    }

    $("#rename").keyup(function () {
        // strip()
        if ($(this).val().replace(/^\s\s*/, '').replace(/\s\s*$/, '') == "") {
            $("#rename-feedback").html("文件名不能为空。");
            $("#rename-feedback")[0].style.display = "block";
            $("#save-btn")[0].disabled = true;
            $("#save-git-btn")[0].disabled = true;
        } else {
            $("#rename-feedback")[0].style.display = "none";
            $("#rename-feedback").html("");
            $("#save-btn")[0].disabled = false;
            $("#save-git-btn")[0].disabled = false;
        }
    })

    function postData(dataChanged, isgitted) {
        var data = JSON.stringify({
            'data': dataChanged,
            'isgitted': isgitted,
            'newname': $("#rename").val(),
            'description': $("#description").text()
        })
        return data;
    }

    function savePage(isgitted) {
        var dataChanged = getModifiedTableData();
        if (isgitted == false && JSON.stringify(dataChanged) == "{}") {
            var list = $(".alert")[0].classList;
            for (var i = 3; i < list.length; i++) {
                $('.alert').removeClass(list[i]);
            }
            $("#alert-text").html('No changes detected!');
            $('.alert').addClass('alert-warning').show().delay(2000).fadeOut();
            return;
        }

        if (isgitted == false) {
            $("#SavingModal").modal('show');
        }

        var tips = (isgitted == true) ? "Saving, Committing & Pushing..." : "Saving...";
        $("#modal-status").html(tips);
        var tableData = {};
        $.ajax({
            cache: false,
            type: 'POST',
            url: "/task/write/{{ task.name }}",
            timeout: 30000,
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            data: postData(dataChanged, isgitted),
            success: function (data) { //成功的话，得到消息
                tableData = data;
            },
            complete: function (XMLHttpRequest, textStatus) {
                $("#SavingModal").modal('hide');
                $("#edit-switch")[0].checked = false;
                var list = $(".alert")[0].classList;
                for (var i = 3; i < list.length; i++) {
                    $('.alert').removeClass(list[i]);
                }
                switch (textStatus) {
                    case "timeout":
                        $("#alert-text").html("响应超时，可能未保存");
                        $('.alert').addClass('alert-warning').show().delay(2000).fadeOut();
                        break;
                    case "success":
                        var msg = (JSON.stringify(dataChanged) == "{}") ? '未修改，已提交' : (isgitted == true) ? "已保存，修改已提交" : "已保存";
                        $("#alert-text").html(msg);
                        $('.alert').addClass('alert-success').show().delay(2000).fadeOut();
                        break;
                    default:
                        $("#alert-text").html("保存失败");
                        $('.alert').addClass('alert-danger').show().delay(2000).fadeOut();
                        break;
                }
                initTable(tableData);
                window.pageInitialData = getInitialTableData();
                $("#description").text("");
                $("#changedShowArea").html("");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });
    }

    function reCampbellConfirm() {
        $("#campbellCalcBtn")[0].disabled = !$("#reCampbell")[0].checked;
    }

    $("#modes-selectpicker").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        var mode_select = $("#modes-selectpicker option:selected").text();
        $("#mode_freq").val(window.modes[mode_select]);
    })

    $('#collapseTable').on('hide.bs.collapse', function () {
        $("#more-modes").html("更多");
    });

    $('#collapseTable').on('show.bs.collapse', function () {
        $("#more-modes").html("收起");
    });

    function modesTableInit(data) {
        var $modesTable = $('#modes-table');
        $modesTable.bootstrapTable('destroy').bootstrapTable({
            columns: [
                {
                    title: "模态名称",
                    field: 'name',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    sortable: true
                },
                {
                    title: "Frequency(rad/s)",
                    field: 'freq',
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                },
                {
                    title: "Damping",
                    field: 'damp',
                    align: 'center',
                    valign: 'middle',
                    class: "thead"
                }
            ],
            data: data
        });
    }

    function campbellTrigger(freqmode_freq) {
        // 检查是否已经有计算结果并显示      
        $.ajax({
            cache: false,
            type: 'POST',
            url: "/task/mode/{{ task.name }}",
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
                taskname: '{{ task.name }}'
            }),
            success: function (data) {
                window.modes = data.modes;

                $("#campbell-modal").modal('show');
                if (JSON.stringify(data) == "{}") {
                    $("#noCalcLabel").html("没有计算记录。");
                    $("#noCalcLabel")[0].style.display = "block";
                    $("#reCampbellForm")[0].style.display = "none";
                    $("#campbellCalcBtn")[0].disabled = false;
                } else {
                    modesTableInit(data.table_data);

                    $("#noCalcLabel")[0].style.display = "none";
                    for (property in data.modes) {
                        $("#modes-selectpicker").append('<option>' + property + '</option>');
                    }
                    $('.selectpicker').selectpicker('refresh');
                    $("#modes-selectpicker").selectpicker('val', data.tower_mode_1);
                    $("#reCampbellForm")[0].style.display = "block";
                    $("#campbellCalcBtn")[0].disabled = true;
                    $("#reCampbell")[0].checked = false;
                }
            }
        });
    }

    function campbell() {
        $("#modal-status").html("正在提交计算...");
        $.ajax({
            cache: false,
            type: 'POST',
            url: "/task/campbell/{{ task.name }}",
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            success: function (data) {
                $("#SavingModal").modal('hide');
                var list = $(".alert")[0].classList;
                for (var i = 3; i < list.length; i++) {
                    $('.alert').removeClass(list[i]);
                }
                if (data.calc) {
                    $("#alert-text").html('计算已提交!');
                    $('.alert').addClass('alert-success').show().delay(2000).fadeOut();
                    $.ajax({
                        cache: false,
                        type: 'POST',
                        url: "/task/mode_check/{{ task.name }}",
                        dataType: "json",
                        contentType: 'application/json; charset=UTF-8',
                        data: JSON.stringify({
                            taskname: '{{ task.name }}'
                        }),
                        success: function (data) {
                            var list = $(".alert")[0].classList;
                            for (var i = 3; i < list.length; i++) {
                                $('.alert').removeClass(list[i]);
                            }
                            if (data.completed) {
                                $("#alert-text").html('Campbell 计算完成!');
                                $('.alert').addClass('alert-success').show();
                            } else {
                                $("#alert-text").html('Campbell 计算超时!');
                                $('.alert').addClass('alert-danger').show();
                            }
                        },
                        error: function () {
                            var list = $(".alert")[0].classList;
                            for (var i = 3; i < list.length; i++) {
                                $('.alert').removeClass(list[i]);
                            }
                            $("#alert-text").html('计算失败!');
                            $('.alert').addClass('alert-danger').show();
                        }
                    });
                } else {
                    $("#alert-text").html('计算提交失败!');
                    $('.alert').addClass('alert-danger').show().delay(2000).fadeOut();
                }
            },
            error: function () {
                $("#SavingModal").modal('hide');
                var list = $(".alert")[0].classList;
                for (var i = 3; i < list.length; i++) {
                    $('.alert').removeClass(list[i]);
                }
                $("#alert-text").html('计算提交失败!');
                $('.alert').addClass('alert-danger').show().delay(2000).fadeOut();
            },
            complete: function () {
            }
        });
    }

    window.onload = function () {
    }

</script>

{% endblock content %}