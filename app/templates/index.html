{% extends 'base.html' %}

{% block flash %}
{% for message in get_flashed_messages() %}
{% if "成功" in message  %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
    {{ message }}
</div>
{% endif %}
{% endfor %}
{% endblock flash %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static',filename='css/my_select.css') }}">
<style>
    .alert {
        position: fixed;
        top: 56px;
    }

    #task-search-input:focus {
        border-color: #7952b3;
        box-shadow: 0 0 0 3px rgba(121, 82, 179, .25)
    }

    .table-striped>tbody>tr:nth-child(2n+1)>td,
    .table-striped>tbody>tr:nth-child(2n+1)>th {
        background-color: #F6F8FA
    }

    .thead {
        font-size: 13px;
    }
    
</style>
{% endblock styles %}

{% block content %}

<header class="navbar navbar-expand-lg navbar-dark bd-navbar">
    <div class="container-fluid">
        <a class="navbar-brand" id="navbar-brand" href="{{ url_for('main.index') }}">
            <span><img src="{{ url_for('static', filename='img/title-logo.png') }}" alt="" height="35px">
                <label style="color: white; font-weight: bold; font-size: 18px;"> 定制化控制业务工作台（暂定）</label>
            </span>
        </a>
        <button class="navbar-toggler btn-sm" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
            style="height: 35px;">
            <span class="fas fa-bars"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">                   
                </li>
                <li class="nav-item">
                </li>
            </ul>
            <form class="form-inline my-3 my-lg-0">
                <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle btn-bd-download" type="button" id="dropdownMenu2"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                        style="width: 130px; height: 35px;">
                        <i class="fas fa-user-cog"></i> {{ user.realname }}
                    </button>
                    <div class="dropdown-menu dropdown-menu-left" aria-labelledby="dropdownMenu2"
                        style="min-width: 100%">
                        <button class="dropdown-item" type="button" data-toggle="modal" data-target="#ProfileModal">
                            <span><i class="fas fa-user" style="color: gray"></i> 个人信息</span>
                        </button>
                        <a class="dropdown-item" href="{{ url_for('auth.reset') }}">
                            <span><i class="fas fa-lock" style="color: gray"></i> 修改密码</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                            <span><i class="fas fa-sign-out-alt" style="color: gray"></i> 注销</span>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</header>

<!-- 工具栏 -->
<div class="container-fluid">
    <div class='d-md-flex justify-content-between' id="tool-bar-row">
        <div class="align-self-center">
            <button class="btn btn-bd-primary col-auto" type="button" data-toggle="modal"
                data-target="#NewTaskModal">新建任务</button>
            <a class="btn btn-bd-primary" href="{{ url_for('main.utils') }}" target="_blank">XML Utils</a>            
        </div>
        <div class="p-2 flex-grow-1"></div>
        <div class="p-2">
            <select class="selectpicker" id="selectpicker" data-style="btn-outline-0" 
                title="过滤选项" multiple>
                <option>任务名</option>
                <option>创建人</option>
                <option>任务状态</option>
                <option>Bladed版本</option>
            </select>
        </div>
        <div class="p-2 flex-grow-1">
            <input type="search" class="form-control" id="task-search-input" placeholder="查询..."
                aria-label="Search for..." autocomplete="off" data-docs-version="4.3" onsearch="getData()">
        </div>
        <div class="p-2 align-self-center">
            <div class="custom-control custom-switch" id="switch">
                <input type="checkbox" class="custom-control-input" id="view-switch" onchange="getData()">
                <label class="custom-control-label" for="view-switch">显示所有任务</label>
            </div>
        </div>
    </div>
</div>

<!-- TASKS TABLE -->
<div class="container-fluid" id="table_user_view" style="height:100%">
    <div class="table-responsive" id="div-table" style="height:100%">
        <table id="table" class="table table-striped table-sm table-bordered table-hover" data-pagination="true"
            data-resizable="false">
        </table>
    </div>
</div>
<!-- Profile Modal -->
<div class="modal fade" id="ProfileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">个人信息 - {{ user.realname }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">总任务数:</label>
                        <input type="text" class="form-control" value="{{ tasks_amount }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="col-form-label">用户名：</label>
                        <input type="text" class="form-control" value="{{ user.username }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">职位：</label>
                        <input type="text" class="form-control" value="{{ user.role }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">电子邮箱：</label>
                        <input type="text" class="form-control" value="{{ user.email }}" disabled>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Saving Modal -->
<div class="modal fade" id="SavingModal" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-body text-center">
            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="48px" height="60px"
                viewBox="0 0 24 30" style="enable-background:new 0 0 50 50;" xml:space="preserve">
                <rect x="0" y="0" width="4" height="10" fill="#FF6700" transform="translate(0 15.1665)">
                    <animateTransform attributeType="xml" attributeName="transform" type="translate"
                        values="0 0; 0 20; 0 0" begin="0" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </rect>
                <rect x="10" y="0" width="4" height="10" fill="#FF6700" transform="translate(0 11.5002)">
                    <animateTransform attributeType="xml" attributeName="transform" type="translate"
                        values="0 0; 0 20; 0 0" begin="0.2s" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </rect>
                <rect x="20" y="0" width="4" height="10" fill="#FF6700" transform="translate(0 1.83315)">
                    <animateTransform attributeType="xml" attributeName="transform" type="translate"
                        values="0 0; 0 20; 0 0" begin="0.4s" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </rect>
            </svg>
            <p style="color: white;" Bold id="savingModalText">正在新建任务......</p>
        </div>
    </div>
</div>

<!-- NewTaskModal -->
<div class="modal fade" id="NewTaskModal" tabindex="-1" role="dialog" aria-labelledby="newTaskModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTaskModalLabel" style="font-weight: bold; color: #7952b3;">
                    <i class="fas fa-folder-plus"></i>
                    新建任务
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" enctype="multipart/form-data" id="newtaskform">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div class="form-group" style="margin-bottom: 6px;">
                        <label for="task-name" class="col-form-label" style="padding-bottom: 0px;">
                            <label style="color: red">*</label>
                            任务名:
                        </label>
                        {{ new_task_form.taskname(class="form-control", type="text", id="task-name", autocomplete="off", spellcheck="false") }}
                        <div class="invalid-feedback" id="task-name-errors"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 6px;">
                        <label for="bladed-file-input" class="col-form-label" style="padding-bottom: 0px;">
                            <label style="color: red">*</label>
                            Bladed模型:
                        </label>
                        <div id="bladed-file-input">
                            <div class="file-loading">
                                {{ new_task_form.bladed(id="input-bladed", spellcheck="false")}}
                            </div>
                        </div>
                        <div class="invalid-feedback" id="bladed-file-errors"></div>
                    </div>
                    <label class="col-form-label" style="padding-bottom: 0px;">
                        <label style="color: red">*</label>
                        控制器：
                    </label>
                    <div class="card">
                        <div class="card-body text-center" style="padding: 10px;">
                            <div class="form-row">
                                <div class="form-group col-sm-6">
                                    <label for="turbine_platform">机型平台：</label>
                                    {{ new_task_form.turbine_platform(class="selectpicker", id="turbine_platform", data_style="btn-outline-0") }}
                                </div>
                                <div class="form-group col-sm-6">
                                    <label for="turbine_model">机组型号：</label>
                                    {{ new_task_form.turbine_model(class="selectpicker", id="turbine_model", data_style="btn-outline-0") }}
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-sm-6" style="margin-bottom: 0;">
                                    <label for="blade_model">叶片型号：</label>
                                    {{ new_task_form.blade_model(class="selectpicker", id="blade_model", data_style="btn-outline-0") }}
                                </div>
                                <div class="form-group col-sm-6" style="margin-bottom: 0;">
                                    <label for="tower_type">塔架类型：</label>
                                    {{ new_task_form.tower_type(class="selectpicker", id="tower_type", data_style="btn-outline-0") }}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between" style="height: 20px; cursor: pointer;" id="pulldowndiv"
                                data-toggle="collapse" data-target="#collapseController" onclick="arrowChange()"
                                onmousemove="pullDownEmphasize()" onmouseout="pullDownRecover()">
                                <div class="p-2 flex-grow-1 align-self-center">
                                    <hr>
                                </div>
                                <div class="p-2 align-self-center">
                                    <i class="fas fa-angle-down" id="arrow-angle"></i>
                                </div>
                                <div class="p-2 flex-grow-1 align-self-center">
                                    <hr>
                                </div>
                            </div>
                            <div class="collapse" id="collapseController">
                                <div class="card card-body" style="padding: 10px;" id="controllerInfo">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding-right: 0px;">
                    <div class="container-fluid" style="padding-right: 10px;">
                        <div class="d-flex justify-content-between">
                            <div class="form-check p-2 align-self-center">                                
                                {{ new_task_form.add_to_git(class="form-check-input", type="checkbox", id="add-to-git", checked=true) }}
                                <label class="form-check-label" for="add-to-git" id="check-for-add-to-git">
                                    提交至Git仓库
                                </label>
                            </div>
                            <div class="p-2"></div>
                            <div class="p-2">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                                {{ new_task_form.create_submit(class="btn btn-primary", type="submit", value="保存",
                                onclick="loadingShow('create')") }}
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EditTaskModal -->
<div class="modal fade" id="EditTaskModal" tabindex="-1" role="dialog" aria-labelledby="EditTaskModal"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel" style="font-weight: bold; color: #7952b3;">
                    <i class="fas fa-edit"></i>
                    编辑任务
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" enctype="multipart/form-data" id="edit-task-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div class="form-group" id="task-name-in-edit-modal">

                    </div>
                    <div class="form-group">
                        <label for="edit-input-bladed" class="col-form-label">
                            <!-- <label style="color: red">*</label> -->
                            <i class="fas fa-info-circle tips" data-toggle="tooltip" title="重新上传Bladed模型将删除旧模型。"
                                style="color:#FFC107;z-index:1071;"></i> 机组模型：
                        </label>
                        <div id="edit-bladed-file-input">
                            <div class="file-loading">
                                {{ edit_task_form.bladed(id="edit-input-bladed")}}
                            </div>
                        </div>
                        <div class="invalid-feedback" id="edit-bladed-file-errors"></div>
                    </div>
                    <label class="col-form-label" style="padding-bottom: 0px;">
                        <label style="color: red">*</label>
                        控制器：
                    </label>
                    <div class="card">
                        <div class="card-body text-center" style="padding: 10px;">
                            <div class="form-row">
                                <div class="form-group col-sm-6">
                                    <label for="edit_turbine_platform">机型平台：</label>
                                    {{ edit_task_form.turbine_platform(class="selectpicker", id="edit_turbine_platform", data_style="btn-outline-0") }}
                                </div>
                                <div class="form-group col-sm-6">
                                    <label for="edit_turbine_model">机组型号：</label>
                                    {{ edit_task_form.turbine_model(class="selectpicker", id="edit_turbine_model", data_style="btn-outline-0") }}
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-sm-6" style="margin-bottom: 0;">
                                    <label for="edit_blade_model">叶片型号：</label>
                                    {{ edit_task_form.blade_model(class="selectpicker", id="edit_blade_model", data_style="btn-outline-0") }}
                                </div>
                                <div class="form-group col-sm-6" style="margin-bottom: 0;">
                                    <label for="edit_tower_type">塔架类型：</label>
                                    {{ edit_task_form.tower_type(class="selectpicker", id="edit_tower_type", data_style="btn-outline-0") }}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between" style="height: 20px; cursor: pointer;" id="edit_pulldowndiv"
                                data-toggle="collapse" data-target="#edit_collapseController" onclick="edit_arrowChange()"
                                onmousemove="edit_pullDownEmphasize()" onmouseout="edit_pullDownRecover()">
                                <div class="p-2 flex-grow-1 align-self-center">
                                    <hr>
                                </div>
                                <div class="p-2 align-self-center">
                                    <i class="fas fa-angle-down" id="edit_arrow-angle"></i>
                                </div>
                                <div class="p-2 flex-grow-1 align-self-center">
                                    <hr>
                                </div>
                            </div>
                            <div class="collapse" id="edit_collapseController">
                                <div class="card card-body" style="padding: 10px;" id="edit_controllerInfo">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    {{ edit_task_form.modify_submit(class="btn btn-danger", type="submit", value="确认修改",
                    onclick="loadingShow('update')") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- DeleteTaskModal -->
<div class="modal fade" id="DeleteTaskModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="delete-task-modal-title" style="font-weight: bold">
                    <span><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <label class="text-danger" for=" delete-task-modal-title">警告</label>
                    </span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" id="delete-modal-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    {{ delete_task_form.taskname(id="delete-taskname", type="text", style="display: none") }}
                    <p></p>
                    <span>
                        {{ delete_task_form.delete_files(type="checkbox", id="check-delete-files") }}
                        <label for="check-delete-files">同时删除已上传文件（将删除Git记录）</label>
                    </span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    {{ delete_task_form.delete_submit(type="submit", class="btn btn-danger", value="确认删除") }}
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">    
    // 避免select第一次点击无效 
    $('select').selectpicker();    

    function loadingShow(mode) {
        if ($("#task-name").val() == "" || $("#input-bladed").val() == "") {
            return;
        }
        var isGit = document.getElementById("check-for-add-to-git")
        if (mode == 'creat' && isGit.checked) {
            $("#savingModalText").html("上传文件并提交至Git...");
        }
        if (mode == 'update' && isGit.checked) {
            $("#savingModalText").html("更新文件并提交至Git...");
        }
        $("#NewTaskModal").modal('hide');
        $("#EditTaskModal").modal('hide');
        $("#SavingModal").modal('show');
    }

    function pullDownEmphasize() {
        $("#pulldowndiv")[0].style.color = "blue";
        $("#pulldowndiv")[0].style.fontSize = "large";
    }
    function pullDownRecover() {
        $("#pulldowndiv")[0].style.color = "";
        $("#pulldowndiv")[0].style.fontSize = "";
    }

    function arrowChange() {
        var angle = $("#arrow-angle"); 
        if (angle[0].classList.contains("fa-angle-down")){
            angle.removeClass("fa-angle-down");
            angle.addClass("fa-angle-up");
        }else{
            angle.removeClass("fa-angle-up");
            angle.addClass("fa-angle-down");
        }
    }

    function edit_pullDownEmphasize() {
        $("#edit_pulldowndiv")[0].style.color = "blue";
        $("#edit_pulldowndiv")[0].style.fontSize = "large";
    }
    function edit_pullDownRecover() {
        $("#edit_pulldowndiv")[0].style.color = "";
        $("#edit_pulldowndiv")[0].style.fontSize = "";
    }

    function edit_arrowChange() {
        var angle = $("#edit_arrow-angle"); 
        if (angle[0].classList.contains("fa-angle-down")){
            angle.removeClass("fa-angle-down");
            angle.addClass("fa-angle-up");
        }else{
            angle.removeClass("fa-angle-up");
            angle.addClass("fa-angle-down");
        }
    }

    function getObjectKeys(object)
    {
        var keys = [];
        for (var property in object)
        keys.push(property);
        return keys;
    }
    
    function getObjectValues(object)
    {
        var values = [];
        for (var property in object)
        values.push(object[property]);
        return values;
    }

    $("#turbine_platform").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        
        $("#turbine_model").empty();
        var turbine_platform_select = $("#turbine_platform option:selected").text();        
        for (property in controllerTree[turbine_platform_select]){
            $("#turbine_model").append('<option value=' + property + '>' + property + '</option>');
        }   
        $("#blade_model").empty();
        var turbine_model_select = $("#turbine_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select]){
            $("#blade_model").append('<option value=' + property + '>' + property + '</option>');
        }  
        $("#tower_type").empty();
        var blade_model_select = $("#blade_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select][blade_model_select]){
            $("#tower_type").append('<option value=' + property + '>' + property + '</option>');
        }
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh');
        showController();     
    })

    $("#turbine_model").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        
        $("#blade_model").empty();
        var turbine_platform_select = $("#turbine_platform option:selected").text();
        var turbine_model_select = $("#turbine_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select]){
            $("#blade_model").append('<option value=' + property + '>' + property + '</option>');
        }   
        $("#tower_type").empty();
        var blade_model_select = $("#blade_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select][blade_model_select]){
            $("#tower_type").append('<option value=' + property + '>' + property + '</option>');            
        }
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh'); 
        showController();   
    })

    $("#blade_model").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        
        $("#tower_type").empty();
        var turbine_platform_select = $("#turbine_platform option:selected").text();
        var turbine_model_select = $("#turbine_model option:selected").text();
        var blade_model_select = $("#blade_model option:selected").text();
        var tower_type_obj = controllerTree[turbine_platform_select][turbine_model_select][blade_model_select]        
        for (property in tower_type_obj){
            $("#tower_type").append('<option value=' + property + '>' + property + '</option>');
        }
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh'); 
        showController();  
    })

    $("#tower_type").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh');    
        showController();
    })

    
    function set_edit_selected_choices(tp, tm, bm, tt){
        window.controllerTree = {{ controller_tree | tojson | safe }};
        // 初始化select
        $("#edit_turbine_platform").empty();
        for (property in controllerTree){
            $("#edit_turbine_platform").append('<option value=' + property + '>' + property + '</option>')
        } 
        $("#edit_turbine_model").empty();
        for (property in controllerTree[tp]){
            $("#edit_turbine_model").append('<option value=' + property + '>' + property + '</option>')
        }   
        $("#edit_blade_model").empty();
        for (property in controllerTree[tp][tm]){
            $("#edit_blade_model").append('<option value=' + property + '>' + property + '</option>');
        }  
        $("#edit_tower_type").empty();
        for (property in controllerTree[tp][tm][bm]){
            $("#edit_tower_type").append('<option value=' + property + '>' + property + '</option>');        
        }
         
        var edit_controller = controllerTree[tp][tm][bm][tt]
        var edit_controllerStr = edit_controller[0] + '<br>' + edit_controller[1];
        $("#edit_controllerInfo").html(edit_controllerStr);        
        
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh');
    }
    
    $("#edit_turbine_platform").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        
        $("#edit_turbine_model").empty();
        var turbine_platform_select = $("#edit_turbine_platform option:selected").text();        
        for (property in controllerTree[turbine_platform_select]){
            $("#edit_turbine_model").append('<option value=' + property + '>' + property + '</option>');
        }   
        $("#edit_blade_model").empty();
        var turbine_model_select = $("#edit_turbine_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select]){
            $("#edit_blade_model").append('<option value=' + property + '>' + property + '</option>');
        }  
        $("#edit_tower_type").empty();
        var blade_model_select = $("#edit_blade_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select][blade_model_select]){
            $("#edit_tower_type").append('<option value=' + property + '>' + property + '</option>');
        }
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh');
        showEditController();     
    })

    $("#edit_turbine_model").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        
        $("#edit_blade_model").empty();
        var turbine_platform_select = $("#edit_turbine_platform option:selected").text();
        var turbine_model_select = $("#edit_turbine_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select]){
            $("#edit_blade_model").append('<option value=' + property + '>' + property + '</option>');
        }   
        $("#edit_tower_type").empty();
        var blade_model_select = $("#edit_blade_model option:selected").text();
        for (property in controllerTree[turbine_platform_select][turbine_model_select][blade_model_select]){
            $("#edit_tower_type").append('<option value=' + property + '>' + property + '</option>');            
        }
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh'); 
        showEditController();   
    })

    $("#edit_blade_model").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {        
        $("#edit_tower_type").empty();
        var turbine_platform_select = $("#edit_turbine_platform option:selected").text();
        var turbine_model_select = $("#edit_turbine_model option:selected").text();
        var blade_model_select = $("#edit_blade_model option:selected").text();
        var tower_type_obj = controllerTree[turbine_platform_select][turbine_model_select][blade_model_select]        
        for (property in tower_type_obj){
            $("#edit_tower_type").append('<option value=' + property + '>' + property + '</option>');
        }
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh'); 
        showEditController();  
    })

    $("#edit_tower_type").on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
        $('.selectpicker').selectpicker('render');
        $('.selectpicker').selectpicker('refresh');    
        showEditController();
    })

    function showController(){
        var turbine_platform_select = $("#turbine_platform option:selected").text();
        var turbine_model_select = $("#turbine_model option:selected").text();
        var blade_model_select = $("#blade_model option:selected").text();
        var tower_type_select = $("#tower_type option:selected").text();
        var controller = controllerTree[turbine_platform_select][turbine_model_select][blade_model_select][tower_type_select]
        var controllerStr = controller[0] + '<br>' + controller[1];
        $("#controllerInfo").html(controllerStr);
    }

    function showEditController(){
        var turbine_platform_select = $("#edit_turbine_platform option:selected").text();
        var turbine_model_select = $("#edit_turbine_model option:selected").text();
        var blade_model_select = $("#edit_blade_model option:selected").text();
        var tower_type_select = $("#edit_tower_type option:selected").text();
        var controller = controllerTree[turbine_platform_select][turbine_model_select][blade_model_select][tower_type_select]
        var controllerStr = controller[0] + '<br>' + controller[1];
        $("#edit_controllerInfo").html(controllerStr);
    }

    $('#NewTaskModal').on('show.bs.modal', function () {
        window.controllerTree = {{ controller_tree | tojson | safe }};
        showController();
    });


    $(document).ready(function () {
        var validator;
        validator = $("#newtaskform").validate({
            rules: {
                taskname: {
                    required: true,
                    validateTaskExist: true,
                    validateTaskEmpty: true
                },
                bladed: {
                    required: true
                }
            },
            messages: {          //自定义提示信息
                taskname: {
                    required: "任务名不能为空。"
                },
                bladed: {
                    required: "需要上传Bladed模型。"
                }
            },
            errorPlacement: function (error, element) {      //错误信息的位置
                tasknameerrors = document.getElementById("task-name-errors");
                bladedfileerrors = document.getElementById("bladed-file-errors");
                if (error[0].id == "task-name-error") {
                    $("#task-name-errors").html(error.text());
                    tasknameerrors.style.display = "block";
                } else if (error[0].id == "input-bladed-error") {
                    $("#bladed-file-errors").html(error.text());
                    bladedfileerrors.style.display = "block";
                }
                else {
                    tasknameerrors.style.display = "none";
                    bladedfileerrors.style.display = "none";
                }
            }
        });
        $.validator.addMethod(  //添加自定义验证函数
            "validateTaskExist",       //自定义验证函数的名称
            function (value, element, params) {
                $.ajax({        //发送Ajax请求
                    url: "/task/validate/name_exist",       // 接收远程验证的地址
                    type: "post",
                    dataType: "json",
                    data: {
                        taskname: function () { return $("#task-name").val(); }
                    },
                    success: function (data) {
                        tasknameerrors = document.getElementById("task-name-errors");
                        if (data['exist']) {
                            $("#task-name-errors").html("任务已存在。");
                            tasknameerrors.style.display = "block";
                        } else if (data['empty']) {
                            $("#task-name-errors").html("任务名不能为空。");
                            tasknameerrors.style.display = "block";
                        } else {
                            tasknameerrors.style.display = "none";
                        }
                    }
                });
                return true;
            }
        );
        $.validator.addMethod(  //添加自定义验证函数
            "validateTaskEmpty",       //自定义验证函数的名称
            function (value, element, params) {
                $.ajax({        //发送Ajax请求
                    type: "POST",
                    url: "/task/validate/name_empty",
                    dataType: "json",    //数据类型为json,发回的数据已自动解析
                    data: {
                        taskname: function () { return $("#task-name").val(); }
                    },
                    success: function (data) {
                        tasknameerrors = document.getElementById("task-name-errors");
                        if (!data) {
                            $("#task-name-errors").html("任务名不能为空。");
                            tasknameerrors.style.display = "block";
                        }
                    }
                });
                return true;
            }
        );

        $("#input-bladed").fileinput({
            showPreview: false,
            showUpload: false,
            // elErrorContainer: '#bladed-file-errors',
            allowedFileExtensions: ["$pj", "prj"],
        }).on('fileloaded', function(event, numFiles, label) {
            var bladedfileerrors = document.getElementById("bladed-file-errors");
            bladedfileerrors.style.display = "none";
        }).on('fileerror', function(event, data, msg) {
            var bladedfileerrors = document.getElementById("bladed-file-errors");
            bladedfileerrors.innerHTML = 'Invalid extension for file "' + data.file.name + '". Only "$pj, prj" files are supported.';
            bladedfileerrors.style.display = "block";
        });

        $("#input-xml").fileinput({
            showPreview: false,
            showUpload: false,
            elErrorContainer: '#xml-file-errors',
            allowedFileExtensions: ["xml"]
        });
    });

    $('#EditTaskModal').on('hidden.bs.modal', function () {
        $("#edit-bladed-file-input").find(".file-caption")[0].classList.remove("icon-visible")
        $("#edit-bladed-file-input").find(".file-caption-name")[0].value = "";
    });

    function openTask(taskname) {
        var url = "{{ url_for('task.work', taskname=taskname) }}";
        // window.open(url + "/" + taskname)

        $.ajax({
            type: 'POST',
            url: "/task/enter",
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(
                taskname
            ),
            success: function (data) {
            },
            complete: function () {
                getData();
            }
        });
    }

    window.operateEvents = {
        'click #edit-badge': function (e, value, row, index) {
            var pattern = /">(.+)</i;
            var taskName = pattern.exec(row.name)[1];
            var info = {}
            var inputHtml = '<label for="edit-task-name" class="col-form-label"><label style="color: red">*</label>任务名:</label>{{ edit_task_form.taskname(class="form-control", type="text", id="edit-task-name", readonly=true) }}';
            $("#task-name-in-edit-modal").html(inputHtml);
            $("#EditTaskModal").modal('show');
            $("#edit-task-name")[0].value = taskName;

            $.ajax({
                type: 'POST',
                url: "/task/info",
                dataType: "json",
                contentType: 'application/json; charset=UTF-8',
                data: JSON.stringify({
                    taskname: taskName
                }),
                success: function (data) { //成功的话，得到消息
                    info = data;
                    set_edit_selected_choices(info['turbine_platform'], info['turbine_model'], info['blade_model'], info['tower_type'])
                    $("#edit_turbine_platform").selectpicker('val', info['turbine_platform']);
                    $("#edit_turbine_model").selectpicker('val', info['turbine_model']);
                    $("#edit_blade_model").selectpicker('val', info['blade_model']);
                    $("#edit_tower_type").selectpicker('val', info['tower_type']);
                },
                complete: function () {
                    $("#edit-input-bladed").fileinput({
                        showPreview: false,
                        showUpload: false,
                        // elErrorContainer: '#edit-bladed-file-errors',
                        allowedFileExtensions: ["$pj", "prj"],
                        // initialCaption: files.bladed.filename
                    }).on('fileloaded', function(event, numFiles, label) {
                        var bladedfileerrors = document.getElementById("edit-bladed-file-errors");
                        bladedfileerrors.style.display = "none";
                    }).on('fileerror', function(event, data, msg) {
                        var bladedfileerrors = document.getElementById("edit-bladed-file-errors");
                        bladedfileerrors.innerHTML = 'Invalid extension for file "' + data.file.name + '". Only "$pj, prj" files are supported.';
                        bladedfileerrors.style.display = "block";
                    });
                    // $("#edit-bladed-file-errors")[0].classList.value = "invalid-feedback";
                    
                    $("#edit-bladed-file-input").find(".file-caption-name")[0].value = info.bladed;
                    if (info.bladed) {
                        $("#edit-bladed-file-input").find(".file-caption")[0].classList.add("icon-visible");
                        $("#edit-bladed-file-input").find(".file-caption-icon").html('<i class="fas fa-file"></i>');
                    }
                }
            });
        },
        'click #delete-badge': function (e, value, row, index) {
            var pattern = /">(.+)</i;
            var taskName = pattern.exec(row.name)[1];
            $("#delete-taskname").val(taskName);
            $("#delete-modal-form").find("p").html('确认删除任务 <label style="color: #7952b3; font-weight: bold;">' + taskName + '</label> 吗？');
        }
    }

    function tableData(data) {
        var viewSwitch = document.getElementById("view-switch");
        if (viewSwitch.checked) {
            return data.all;
        }
        return data.user;
    }

    function pageList(data) {
        var showData = tableData(data);
        var list = [10];
        for (var i = 0; i < Math.ceil((showData.length - 10) / 10); i++) {
            list.push(list[list.length - 1] + 5);
            list.push(20 + i * 10);
        }
        return list;
    }

    window.addEventListener('resize', function () {
        getData();
    });

    function initTable(data) {
        var $table = $('#table');
        var $div = $('#div-table');
        var table_data = tableData(data);
        var page_list = pageList(data);
        var page_size = $(window).height() > 800 ? 25 : 15;
        $table.bootstrapTable('destroy').bootstrapTable({
            height: $(window).height() - 120,
            columns: [
                {
                    title: "#",
                    field: 'id',
                    align: 'center',
                    valign: 'middle',
                    // sortable: true,  
                    class: "thead"
                },
                {
                    title: "任务名",
                    field: 'name',
                    align: 'left',
                    valign: 'middle',
                    // sortable: true,
                    class: "thead"
                },
                {
                    title: "Bladed版本",
                    field: 'bladed_version',
                    align: 'center',
                    valign: 'middle',
                    // sortable: true,
                    class: "thead"
                },
                {
                    title: "创建人",
                    field: 'creator',
                    align: 'center',
                    valign: 'middle',
                    // sortable: true,
                    class: "thead"
                },
                {
                    title: "创建时间",
                    field: 'date',
                    align: 'center',
                    valign: 'middle',
                    // sortable: true,
                    class: "thead"
                },
                {
                    title: "任务状态",
                    field: 'status',
                    align: 'center',
                    valign: 'middle',
                    // sortable: true,
                    class: "thead"
                },
                {
                    title: "操作",
                    field: "operate",
                    align: 'center',
                    valign: 'middle',
                    class: "thead",
                    events: window.operateEvents,
                }
            ],
            pageSize: page_size,
            pageList: page_list,
            data: table_data
        });
        $('.badge').tooltip('show');
        $('.badge').tooltip('hide');
    }
    function getData() {
        var $table = $('#table');
        var tableData = {};
        $.ajax({
            type: 'POST',
            url: "/task/table",
            dataType: "json",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
                search_key: $("#task-search-input").val(),
                filter: $('#selectpicker').val()
            }),
            success: function (data) { //成功的话，得到消息
                tableData = data;
            },
            complete: function () {
                initTable(tableData);
                $("#SavingModal").modal('hide');
            }
        });
    }
    $(document).ready(function () {
        getData();
        // $('[data-toggle="tooltip"]').tooltip({ container: 'modal-content' });
    });
    
</script>

{% endblock content %}